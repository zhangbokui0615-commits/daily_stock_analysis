import yfinance as yf
import os
import google.generativeai as genai
import requests

# 1. é…ç½®å¸‚åœºè§‚å¯Ÿåå•
MARKETS = {
    "ç¾è‚¡-çº³æ–¯è¾¾å…‹": "^IXIC",
    "ç¾è‚¡-æ ‡æ™®500": "^GSPC",
    "æ—¥è‚¡-æ—¥ç»225": "^N225",
    "Aè‚¡-ä¸Šè¯æŒ‡æ•°": "000001.SS",
    "æ±‡ç‡-ç¾å…ƒ/æ—¥å…ƒ": "JPY=X"
}

def get_global_data():
    summary = "ã€å…¨çƒå¸‚åœºæœ€æ–°æ•°æ®å¿«æŠ¥ã€‘\n"
    for name, code in MARKETS.items():
        try:
            ticker = yf.Ticker(code)
            data = ticker.history(period="2d")
            if len(data) >= 2:
                close_price = data['Close'].iloc[-1]
                prev_price = data['Close'].iloc[-2]
                change = ((close_price - prev_price) / prev_price) * 100
                summary += f"Â· {name}: {close_price:.2f} ({'+' if change>0 else ''}{change:.2f}%)\n"
        except Exception as e:
            summary += f"Â· {name}: æ•°æ®è·å–å¤±è´¥\n"
    return summary

def analyze_and_push():
    # è·å–ç¯å¢ƒå˜é‡ï¼ˆä» GitHub Secrets ä¸­è¯»å–ï¼‰
    gemini_key = os.getenv("GEMINI_API_KEY")
    push_token = os.getenv("PUSHPLUS_TOKEN")
    
    # æŠ“å–æ•°æ®
    market_data = get_global_data()
    
    # AI åˆ†ææŠ¥å‘Š
    genai.configure(api_key=gemini_key)
    # ä½¿ç”¨ç›®å‰æœ€ç¨³å®šçš„æ¨¡å‹å‹å·ï¼Œè§£å†³ NotFound æŠ¥é”™
    model = genai.GenerativeModel('gemini-1.5-flash')
    
    prompt = f"ä½ æ˜¯ä¸€ä¸ªèµ„æ·±è´¢ç»åˆ†æå¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹å…¨çƒå¸‚åœºæ•°æ®è¿›è¡Œç®€çŸ­ç‚¹è¯„ï¼š\n{market_data}\nè¦æ±‚ï¼š1. æ€»ç»“æ˜¨æ™šç¾è‚¡å’Œä»Šæ—©æ—¥è‚¡è¡¨ç°ã€‚2. ä¸ºä¸­å›½æŠ•èµ„è€…æä¾›ä¸€å¥ä»Šæ—¥å»ºè®®ã€‚3. å­—æ•°æ§åˆ¶åœ¨200å­—å†…ã€‚"
    
    try:
        response = model.generate_content(prompt)
        ai_report = response.text
    except Exception as e:
        ai_report = "AI åˆ†ææš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ•°æ®å¿«æŠ¥ã€‚"

    # æ¨é€åˆ°å¾®ä¿¡ (PushPlus)
    content = f"{market_data}\n\nã€AI æ·±åº¦è§£è¯»ã€‘\n{ai_report}"
    payload = {
        "token": push_token,
        "title": "ğŸŒ å…¨çƒè´¢ç»æ—©æŠ¥",
        "content": content,
        "template": "html"
    }
    requests.post("http://www.pushplus.plus/send", json=payload)

if __name__ == "__main__":
    analyze_and_push()
